'use strict';

$(document).ready(function ($) {

	var filials = {
		$selectName: $('.dropdown--city .dropdown__toggle'),
		$selectItems: $('.dropdown--city label'),
		$mapLinks: $('.map-hidden__link'),
		$mapItems: $('.map-icon__item'),
		$mapItemsClose: $('.map-icon__item .close'),
		$gmapCoord: $('.map-google__coord'),

		// contact block
		$contactPhone: $('.contacts__phone'),
		$contactEmail: $('.contacts__email'),
		$contactFax: $('.contacts__fax'),
		$contactAddress: $('.contacts__address'),
		$contactTitle: $('.contacts__main-title'),

		//
		$filialsWrap: $('.map-filials__wrapper'),
		dataItems: filialsData.items,
		columnCount: 3,

		setFilial: function setFilial(filialName) {},

		setSelect: function setSelect(filialName) {
			filials.$selectName.text(filialName);
		},

		setMapBaloon: function setMapBaloon(filialName) {
			this.parents('.map-icon__item').switchClass('active');
		},

		setRowItemByName: function setRowItemByName(filialName, id) {
			// передвигаем страницу
			TweenLite.to(window, 0.5, {
				scrollTo: {
					y: '#filial-id-' + id,
					offsetY: 100
				},
				ease: Power1.easeOut
			});

			// отключаем предыдущие
			$('.map-filials__item-wrap').removeClass('active').find('.map-filials__hidden').slideUp();

			// активируем нужный
			var $mustActiveRow = $('#filial-id-' + id);
			$mustActiveRow.find('.map-filials__item-wrap').addClass('active').find('.map-filials__hidden').slideDown();
		},

		setMapBaloonByName: function setMapBaloonByName(filialName) {
			var $activeLink = filials.$mapLinks.filter('[data-city-name="' + filialName + '"]');
			$activeLink.parents('.map-icon__item').switchClass('active');
		},

		// handlers
		mapItemHandler: function mapItemHandler(event) {
			event.preventDefault();
			var filiaName = $(this).find('.map-hidden__link').filter(':first').data('city-name');
			filials.setFilial(filiaName);
			filials.setSelect(filiaName);
			filials.setMapBaloonByName(filiaName);

			// отключаем предыдущие
			$('.map-filials__item-wrap').removeClass('active').find('.map-filials__hidden').slideUp();
		},
		mapLinkHandler: function mapLinkHandler(event) {
			event.preventDefault();
			event.stopPropagation();
			var filiaName = $(this).data('city-name');
			var id = $(this).data('id');
			filials.setFilial(filiaName);
			filials.setSelect(filiaName);
			filials.setRowItemByName(filiaName, id);
		},
		selectItemHandler: function selectItemHandler(event) {
			event.preventDefault();
			var $self = $(this);
			var filiaName = $self.data('city-name');
			filials.$selectName.text(filiaName);
			filials.setMapBaloonByName(filiaName);
			filials.setFilial(filiaName);
		},
		changeRowFilialHandler: function changeRowFilialHandler() {
			var $self = $(this);
			var $parent = $self.parent();
			var filiaName = $self.data('city-name');
			var isActive = $parent.hasClass('active');
			if (isActive) {
				filials.closeAll();
			} else {
				$('.map-filials__item-wrap').not($parent).removeClass('active').find('.map-filials__hidden').slideUp();

				$parent.addClass('active');
				$self.siblings('.map-filials__hidden').slideDown();
				filials.setMapBaloonByName(filiaName);
			}
		},

		closeAll: function closeAll(event) {
			console.log('closeAll');
			$('.map-filials__item-wrap').removeClass('active').find('.map-filials__hidden').slideUp();

			filials.$mapItems.removeClass('active');
			event.stopPropagation();
		},

		init: function init(filialsData) {
			var columnCount = this.getColumnCount();
			this.render(columnCount);
			this.$mapItems.on('click', this.mapItemHandler);
			this.$selectItems.on('click', this.selectItemHandler);
			this.$mapLinks.on('click', this.mapLinkHandler);
			this.$filialsWrap.on('click', '.map-filials__title', this.changeRowFilialHandler);
			this.$mapItemsClose.on('click', this.closeAll);

			$(window).on('resize', function (event) {
				var columnCount = filials.getColumnCount();
				if (filials.columnCount != columnCount) {
					filials.render(columnCount);
				}
			});
		},

		render: function render(columnCount) {
			var html = '';
			var count = this.dataItems.length;
			var oneColumnLength = Math.round(count / columnCount);
			var indexCount = 0;

			html += '<div class="map-filials__column">';

			this.dataItems.map(function (item, itemIndex) {
				indexCount++;
				html += filials.getHtmlRow(item);
				if (indexCount == oneColumnLength) {
					html += '</div><div class="map-filials__column">';
					indexCount = 0;
				}
			});

			html += '</div>';

			this.$filialsWrap.html(html);
		},

		getColumnCount: function getColumnCount() {
			var width = $(window).width();
			console.log('width + ' + width);
			if (width <= 992) {
				return 2;
			}
			return 3;
		},

		getHtmlRow: function getHtmlRow(item) {
			return '\n\t\t\t\t<div class="map-filials__item" id="filial-id-' + item.ID + '"  data-city-id="' + item.ID + '" data-city-name="' + item.IBLOCK_ELEMENT_PROPERTYS16_CITY + '">\n\t\t\t\t\t<div class="map-filials__item-wrap">\n\t\t\t\t\t\t<div class="map-filials__title" data-city-name="' + item.IBLOCK_ELEMENT_PROPERTYS16_CITY + '" id="elememt-city-' + item.ID + '">' + item.NAME + '</div>\n\t\t\t\t\t\t<div class="map-filials__hidden">\n\t\t\t\t\t\t\t<div class="map-filials__block">\n\t\t\t\t\t\t\t\t<div class="map-filials__cell">\u0422\u0435\u043B\u0435\u0444\u043E\u043D: ' + item.IBLOCK_ELEMENT_PROPERTYS16_PHONE + '</div>\n\t\t\t\t\t\t\t\t<div class="map-filials__cell">E-mail: <a href="mailto:' + item.IBLOCK_ELEMENT_PROPERTYS16_EMAIL + '">' + item.IBLOCK_ELEMENT_PROPERTYS16_EMAIL + '</a></div>\n\t\t\t\t\t\t\t\t<div class="map-filials__cell">\u0410\u0434\u0440\u0435\u0441: ' + item.IBLOCK_ELEMENT_PROPERTYS16_ADDRESS + '</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t';
		}
	};

	filials.init(filialsData);

	// Скрытие
	// ============
	// $('.map-filials__title').on('click', function(event) {
	// var $self = $(this);
	// $self.siblings('.map-filials__hidden').slideToggle();
	// $self.parents('.map-filials__item-wrap').toggleClass('active');
	// });


	$('.dropdown-element').on('click', function () {
		var idCity = $(this).data('value');
		$('.map-filials__item-wrap').removeClass('active');
		$('#filial-id-' + idCity + ' > .map-filials__item-wrap').addClass('active');
		$('.map-filials__hidden').hide();
		$('#filial-id-' + idCity + ' > .map-filials__item-wrap > .map-filials__hidden').show();
	});

	$('.dropdown-element').hide();
	$('.map-filials__item').each(function () {
		var idCity = $(this).data('city-id');
		$('#dropdown-elemen-' + idCity).show();
	});
});

$(window).load(function () {

	// Ресайз карты
	var $mapImage = $('.map-wrapper__image');
	var $mapBaloonWrap = $('.map-icon__wrapper');
	$(window).on('resize', function (event) {
		$mapBaloonWrap.height($mapImage.height());
	});
	$mapBaloonWrap.height($mapImage.height());
	TweenLite.to($('.map-wrapper'), 1, {
		opacity: '1',
		ease: Expo.easeOut
	});
});