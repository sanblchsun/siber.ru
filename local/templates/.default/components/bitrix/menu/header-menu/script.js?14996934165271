'use strict';
$(document).ready(function($) {

	// Ползущая плашка
	// ===============
	var $plank        = $('.header-menu__line');
	var $menuItems    = $('.header-menu__link');
	window.app.plankIsActive = false;
	var menuItemMouseOver = function(obj){
		var $self      = (obj.type == 'mouseover') ? $(this) : obj;
		var $parent    = $self.parent();
		var widthLink  = $self.width();
		var offsetLeft = $parent.position().left;

		window.app.plankIsActive = true;

		$plank.css({
			width: widthLink + 'px',
			left: offsetLeft + 'px'
		});

		$plank.addClass('header-menu__line--show');
	};
	var menuItemMouseOut = function(){
		$plank.removeClass('header-menu__line--show');
	};

	$menuItems.on('mouseover', menuItemMouseOver);
	// $menuItems.on('mouseout', menuItemMouseOut);


	// Выпадающее меню
	// ===============
	var $menuHaveDown  = $('.header-menu__item--have-down .header-menu__link');
	var $menuDown      = $('.menu-down');
	var $menuDownWrap  = $('.menu-down__wrapper');
	var $menuDownTitle = $('.menu-down__title');
	var $headerMenu    = $('.header__item--menu');
	var $header        = $('.header');
	var $icon          = $('.header-menu__icon');
	app.showMenu       = false;
	app.setMenuOffset();


	var menuDownShow  = function(){
		var $self = $(this);
		if ($self.hasClass('header-menu__link') || $self.hasClass('header-menu__icon')) {
			var childClass = $self.parent().data('child-menu');
			menuItemMouseOver($self);
			if (childClass) {
				$('.-' + childClass)
					.addClass('show')
					.siblings()
					.removeClass('show');
			}
		}

		app.showMenu = true;

		$menuDown.addClass('active');
		$header.addClass('header--show-down-menu');
	};

	var menuDownHide = function(){
		app.showMenu = false;
		app.plankIsActive = false;
		setTimeout(function(){
			if (!app.showMenu) {
				$menuDown.removeClass('active');
				$header.removeClass('header--show-down-menu');
				setTimeout(function(){
					$menuDownWrap.removeClass('show');
					if (!app.plankIsActive) {
						menuItemMouseOut();
					}

				}, 300);
			}
		}, 400);
	};

	$icon.on('click', function(event) {
		$(this).parent().addClass('active');
	});

	$icon.on('click', menuDownShow);
	// $menuHaveDown.on('click', menuDownShow);
	$menuDownTitle.on('click', menuDownHide);

	var bindHover = function(){
			$menuDown.on('mouseenter', menuDownShow);
			$menuDown.on('mouseleave', menuDownHide);
			$menuHaveDown.on('mouseenter', menuDownShow);
			$menuHaveDown.on('mouseleave', menuDownHide);
		},
		unBindHover = function(){
			$menuDown.unbind('mouseenter', menuDownShow);
			$menuDown.unbind('mouseleave', menuDownHide);
			$menuHaveDown.unbind('mouseenter', menuDownShow);
			$menuHaveDown.unbind('mouseleave', menuDownHide);
		},
		bindMenuActions = function(){
			if (app.isTablet()) {
				unBindHover();
			} else {
				bindHover();
			}
		};

	bindMenuActions();
	$(window).on('resize', bindMenuActions);


	// Поиск
	// =====
	var $searchBtn   = $('.button-search');
	var $searchBtnMenu   = $('.header-menu__poisk');
	var $searchWrap  = $('.search-wrapper');
	var $searchInput = $('.search-wrapper__input');
	var hideSearch   = function(){
		$searchWrap.removeClass('active');
		$searchBtn.removeClass('active');
	};
	$searchBtn.on('click', function(event) {
		event.preventDefault();
		$searchWrap.toggleClass('active');
		$searchBtn.toggleClass('active');

		if ($searchWrap.hasClass('active')) {
			$searchInput.trigger('focus');
		}
	});
	$searchBtnMenu.on('click', function(event) {
		event.preventDefault();
		$searchWrap.toggleClass('active');
		$searchBtn.toggleClass('active');

		if ($searchWrap.hasClass('active')) {
			$searchInput.trigger('focus');
		}
	});



	// Переключение языка
	// ==================
	var $langBtn  = $('.header-lang');
	var $langWrap = $('.header-lang__wrap');
	var hideLang  = function(){
		$langWrap.removeClass('active');
		$langBtn.removeClass('active');
	};
	$langBtn.on('click', function(event) {
		event.preventDefault();
		$langWrap.toggleClass('active');
		$langBtn.toggleClass('active');
	});


	// 3 уровень
	// =========
	$('.menu-down__item--down').on('click', function(event) {
		// event.preventDefault();
		$('.menu-down__item-down').addClass('active');
	});
	$('.menu-down__title-down').on('click', function(event) {
		// event.preventDefault();
		$('.menu-down__item-down').removeClass('active');

	});


	// Переход из меню при клике по стрелочке на мобильной версии
	// ==========================================================
	$('.icon-down').on('click', function(event) {
		var href  = $(this).siblings('.header-menu__link').attr('href');
		if (href) {
			documen.location.href(href);
		}
	});


	// Закрытие поиска или языка по Esc
	// ================================
	$(document).keydown(function(e) {
		if(e.keyCode === 27) {
			hideLang();
			hideSearch();
		}
	});
	$(document).on('click', function(event) {
		if ($(event.target).closest('.header-lang').length == 0
			&& !$(event.target).hasClass('header-lang')) {
			hideLang();
		}
		if ($(event.target).closest('.search-wrapper').length == 0
			&& !$(event.target).hasClass('button-search')) {
			hideSearch();
		}
	});

});