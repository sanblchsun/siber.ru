'use strict';

$(document).ready(function ($) {

	var calendarMP = {
		$calendarBody: $('.calendar__body'),
		$calendarBtn: $('.calendar__btn'),
		lastData: document.calendarData,

		switchMonth: function switchMonth() {
			var $self = $(this);
			var code = $self.data('code');

			BX.showWait();
			$.ajax({
				url: '/local/api/calendar/',
				type: 'GET',
				dataType: 'json',
				data: { dateCode: code }
			}).done(function (response) {
				calendarMP.lastData = response;
				calendarMP.render();
			}).fail(function () {
				console.log('error');
			}).always(function () {
				BX.closeWait();
			});

			$.ajax({
				url: '/local/api/calendar-mini/',
				type: 'GET',
				dataType: 'json',
				data: { dateCode: code }
			}).done(function (response) {
				$('.menu-news').html(response);
			}).fail(function () {
				console.log('error');
			});
		},

		init: function init() {
			this.render();
			this.$calendarBtn.on('click', this.switchMonth);
		},

		render: function render() {
			if (!this.lastData || !this.lastData.days) {
				console.error('Нет данных для календаря');
			}
			var monthes = this.lastData.month;

			var count = 0;
			for (var code in monthes) {
				count++;
				$('.callendar__month-' + count).text(monthes[code]).data('code', code);
			}

			this.$calendarBody.html('');

			// Перебираем строки
			for (var rowIndex in this.lastData.days) {
				var row = this.lastData.days[rowIndex];
				var $tr = $('<tr></tr>');

				// Перебираем дни (ячейки)
				for (var day in row) {
					var $td = $('<td></td>');
					var $div = $('<td class="calendar__item"></td>');
					var arLinks = row[day].links;
					var linksExists = false;

					if (!row[day].active) {
						$td.addClass('calendar__grey');
					}
					var currentPath = document.location.pathname;
					currentPath = currentPath.replace('/media-center/kalendar-meropriyatij/', '');

					// if (row[day].now) {
					// 	$div.addClass('active');
					// }

					// Перебираем мероприятия (ссылки)
					for (var link in arLinks) {
						linksExists = true;
						// название мероприятия arLinks[link]
						link = link.replace('/media-center/kalendar-meropriyatij/', '');

						if (link == currentPath) {
							$div.addClass('active');
						}
						$div.append('<a href="/media-center/kalendar-meropriyatij/' + link + '" class="calendar__link">' + day + '</a>');
					}

					if (!linksExists) {
						$div.text(day);
					}

					$td.append($div);
					$tr.append($td);
				}

				this.$calendarBody.append($tr);
			};
		}
	};

	calendarMP.init();
});