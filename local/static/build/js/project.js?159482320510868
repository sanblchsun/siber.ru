'use strict';
$(document).ready(function ($) {

	window.app     = {
		$window:          $(window),
		$headerMenu:      $('.header__item--menu'),
		$menuDownWrap:    $('.menu-down__wrapper'),
		additionalHeight: $('.header-menu').height() + $('#panel').height(),
		fullHeaderHeight: $('.header').height() + $('#panel').height(),
		scrollLockStatus: false,


		isTablet: function () {
			return window.innerWidth < 1000;
		},


		getWorkAreaHeight: function () {
			return window.innerHeight;
		},

		getfullHeaderHeight: function () {
			return $('.header').height() + $('#panel').height();
		},

		isFirstScreen: function () {
			var workAreaHeight = app.getWorkAreaHeight() - app.getfullHeaderHeight();
			return app.$window.scrollTop() < workAreaHeight;
		},

		getMenuDownColumnPosition: function () {
			return app.$headerMenu.offset().left;
		},

		setMenuOffset: function () {
			// выставляем актуальный отступ слева
			app.$menuDownWrap.css({'padding-left': app.getMenuDownColumnPosition() + 'px'});
		},

		scrollLock: function () {
			app.scrollLockStatus = true;
		},

		scrollUnLock: function () {
			app.scrollLockStatus = false;
		},

		listFirstScreen: function () {
			TweenMax.to(window, 0.5, {
				scrollTo: {
					y:       '.main-services',
					offsetY: app.getfullHeaderHeight()
				},
				ease:     Power3.easeOut,
				onComplete: function () {
					//console.log('onComplete');
				},
			});
		},

		listSecondScreen: function () {
			TweenMax.to(window, 0.5, {
				scrollTo: {
					y:       '.wrapper',
					offsetY: app.getfullHeaderHeight()
				},
				ease:     Power3.easeOut,
				onComplete: function () {
					app.scrollUnLock();
				},
			});
		}
	};
	app.lastOffset = app.$window.scrollTop();

	// вспомогательная функция переключения класса .active
	// ======================================================
	$.fn.switchClass = function (elClass) {
		if (elClass === undefined) {
			elClass = 'active';
		}
		var $self = $(this);
		$self.addClass(elClass)
			.siblings().removeClass(elClass);
		return $self;
	};


	// Запрет на "hover" при скроллинге страницы
	// ==========================================
	var body = document.body,
		timer;

	window.addEventListener('scroll', function () {
		clearTimeout(timer);
		if (!body.classList.contains('disable-hover')) {
			body.classList.add('disable-hover')
		}
		timer = setTimeout(function () {
			body.classList.remove('disable-hover')
		}, 100);
	}, false);


	// Ресайз секций
	// =============
	var $sections = $('.main-section');
	var $content  = $('.content--vn');
	$content.css({'padding-top': app.getfullHeaderHeight() + 'px'});
	var sectionResize = function () {
		$sections.css({
			height: app.getWorkAreaHeight() - app.getfullHeaderHeight() + 'px'
		});
	};
	window.addEventListener('resize', sectionResize, false);
	sectionResize();


	// Перестройка меню
	// ================
	var $header      = $('.header')
	var isFullHeader = app.$window.scrollTop() < app.getWorkAreaHeight();
	var toggleHeader = function () {
		var isFirstScreen = app.$window.scrollTop() < (app.getWorkAreaHeight() - app.getfullHeaderHeight() - 10);
		if (!isFullHeader && !isFirstScreen) {
			$header.addClass('header--fix');
			isFullHeader = true;
			setTimeout(function () {
				app.setMenuOffset();
			}, 300);

		}

		if (isFullHeader && isFirstScreen) {
			$header.removeClass('header--fix');
			isFullHeader = false;
			setTimeout(function () {
				app.setMenuOffset();
			}, 300);
		}
	};
	toggleHeader();
	window.addEventListener('scroll', toggleHeader, false);
	window.addEventListener('resize', function () {
		app.setMenuOffset();
	}, false);


	// Меню Анимация
	// =========================
	var menuElem = document.querySelector('.menu');

	function toggleMenu() {
		menuElem.classList.toggle('open');
	}

	menuElem.addEventListener('click', toggleMenu);

	// Общие переменные
	// ============================
	var $body        = $('body');
	var $window      = $(window);
	var $html        = $('html');
	var $header      = $('header');
	var $menuWrap    = $('.header__item--menu');
	var $logoWrap    = $('.header__item--logo');
	var $menuBtnWrap = $('.menu');
	var $menuDown    = $('.menu-down');


	// Меню Анимация
	// =========================
	var menu = {
		$menuBtnWrap: $('.menu'),
		menuClose:    function () {
			if ($menuWrap.hasClass('active')) {
				$menuWrap.removeClass('active');
				$logoWrap.removeClass('active');
				$body.removeClass('open');
				$menuBtnWrap.removeClass('active');
				$(document).unbind('click.close');
			}
		}
	};
	app.menu = menu;

	$('.menu').on('click', function (event) {
		$menuWrap.toggleClass('active');
		$logoWrap.toggleClass('active');

		$menuBtnWrap.toggleClass('active');
		$body.toggleClass('open');
		$menuDown.removeClass('active');

		// обработка клика вне объекта
		event.stopPropagation();
		if ($menuWrap.hasClass('active')) {
			$(document).on('click.close', menu.close);
		}
	});
	// чтобы клик внутри объекта не закрывал выпадашку
	$menuWrap.on('click', function (event) {
		event.stopPropagation();
	});
	$window.on('resize', function (event) {
		if ($window.width() > 950 && $menuWrap.hasClass('active')) {
			menu.close();
			// $menuWrap.show();
		}
	});



	// Bitrix admin plank
	// ==================
	var $bxPanel      = $('#bx-panel');
	if ($bxPanel.length > 0) {
		var $bxPanelWrap  = $('#panel');
		var $bxPanelInner = $('#bx-panel-back');
		var bxPanelHeight = $bxPanel.height();
		$header.css({'top': bxPanelHeight + 'px'});
		$bxPanelWrap.css({'height': bxPanelHeight + 'px'});
	}


	/**
	 * анимированный scroll
	 **/
	$.fn.scrollAnimation = function (settings) {
		settings = $.extend({
			offset:           50,
			randDelay:        0,
			removeClassDelay: 2000,
			hideClass:        'scroll-anim',
			transitionClass:  'scroll-anim-transition',
			showClass:        'scroll-anim-active',
			complete:         function () {
			}
		}, settings);

		if (!$(this).length) {
			return this;
		}

		var elements    = $(this).addClass(settings.hideClass),
			scrollTop   = $('html').scrollTop() || $('body').scrollTop(),
			showElement = function (element, index) {
				setTimeout(function () {
					$(element).addClass(settings.showClass);

					setTimeout(function () {
						$(element).removeClass(settings.hideClass + ' ' + settings.showClass + ' ' + settings.transitionClass);
					}, settings.removeClassDelay);
				}, settings.randDelay ? Math.random() * settings.randDelay : settings.delay);

				settings.complete(element);
			};

		setTimeout(function () {
			elements
				.addClass(settings.transitionClass)
				.each(function (index, el) {
					if ($(el).offset().top + settings.offset <= scrollTop + $(window).height()) {
						showElement(el, index);
					}
				});

			function scrollAnimation() {
				if (!elements.length) {
					$(window).off('resize.scrollAnimation scroll.scrollAnimation', scrollAnimation);
				} else {
					var scrollTop = $('html').scrollTop() || $('body').scrollTop(),
						winHeight = $(window).height();

					elements.not('.' + settings.showClass).each(function (index, el) {
						if ($(el).offset().top + settings.offset <= scrollTop + winHeight) {
							showElement(el, index);
							elements = elements.not(this);
						}
					});
				}
			}

			$(window).on('resize.scrollAnimation scroll.scrollAnimation', scrollAnimation);
		}, 200);

		return this;
	};
	(function () {
		var aElements = [
			'.map-main',
			'.main-news',
			'.figures__image',
			'.figures__content'

		];

		$(aElements.join(', ')).scrollAnimation({
			randDelay:     500,
			loadAnimation: true
		});
	})();


	// form
	// ====

	// phone-mask
	// ==========
	var i = 0;
	$('.phone-mask').each(function () {
		i++;
		$(this).addClass('phone-mask--' + i)

		if (typeof MaskedInput === "undefined") return;

		MaskedInput({
			elm:    document.querySelector('.phone-mask--' + i),
			format: '+7 (___) ___-____', separator: '()-+7 '
		});
	});

	if ($('#form').length > 0)
		$('#form').doubleValidate({
			validateSuccess: function (data) {
				$('#form .form__wrapper').slideUp();
				$('#form .form__success').slideDown();
			}
		});


	// Функция рассчета максимального и минимального числа в массиве
	// =================================================================
	Array.max           = function (array) {
		return Math.max.apply(Math, array);
	};
	Array.min           = function (array) {
		return Math.min.apply(Math, array);
	};
	$.fn.alignTheHeight = function () {
		var $elements = $(this);
		if ($elements.length === 0)
			return;

		// откладываем загрузку чтобы рассчет был верный
		$(window).on('load', {elements: $elements}, function (event) {

			var $elements = event.data.elements;
			var arHeights = [];

			if ($elements.length <= 0) {
				return;
			}

			$elements.each(function (index, el) {
				arHeights.push($(el).height());
			});

			var maxHeight = Array.max(arHeights);

			$('<style>' + $elements.selector + '{ height: ' + maxHeight + 'px; }</style>').appendTo('head');

			return $elements;
		});
	};


	// Выравнивание блоков
	$('.photo-slider__item').alignTheHeight();
	$('.galereya-slider__item').alignTheHeight();
	$('.map-item').alignTheHeight();



	// Селект для обычных форм
	// ========================
	$('body').on('click', '#filter-form .dropdown-menu label', function (event) {
		var $self = $(this);
		if (!$self.hasClass('disabled')) {
			var $dropdown = $self.parents('.dropdown');
			var text      = $self.text();
			var value     = $self.data('value') || $self.text();
			$dropdown.find('.dropdown__toggle').text(text);
			$dropdown.find('input').val(value);
			$('#filter-form').submit();
		}
	});


	// Прокрутка экрана
	// ================
	function scrollToElementHandler(event) {
		event.preventDefault();

		var $self  = $(this);
		var target = $self.attr('href') || $self.data('href');

		if (!target) {
			console.error('Не корректный target для кнопки');
		}

		TweenMax.to(window, 1, {scrollTo: {y: target, offsetY: app.fullHeaderHeight}});
	}

	$('.js-scroll-to').on('click', scrollToElementHandler);
	$('.double-menu__item a').each(function (index, el) {
		if ($(el).attr('href').indexOf('#') != -1) {
			$(el).on('click', scrollToElementHandler);
		}
	});


	// Выход из профиля
	// ================
	$('body').on('click', '.header-closed-lk__exit', function () {
		$.ajax({
			url: '/local/api/exit-profile/'
		}).done(function () {
			location.reload();
		}).fail(function () {
		})
	});

});